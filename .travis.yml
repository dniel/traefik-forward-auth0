if: tag IS blank
jdk:
  - oraclejdk13
language: java
install: true
cache:
  directories:
    - "$HOME/.m2/repository"
    - "$HOME/.sonar/cache"
addons:
  sonarcloud:
    organization: dniel-github
    token: "$SONAR_TOKEN"
services:
  - docker
before_script:
  - export TRAVIS_TAG=$(git rev-parse --short ${TRAVIS_COMMIT})
  - export BRANCH=${TRAVIS_PULL_REQUEST_BRANCH:-$TRAVIS_BRANCH}
  - export COMMIT_TIME=$(git log -1 --pretty=format:%ct|date +"%m%d%Y-%H%M")
  - export APP_VERSION=$COMMIT_TIME-$TRAVIS_TAG
  - echo "$TRAVIS_TAG $TRAVIS_COMMIT $BRANCH $COMMIT_TIME"
script:
  - echo "TRAVIS_SECURE_ENV_VARS=${TRAVIS_SECURE_ENV_VARS}";
  - |
    if [ "${TRAVIS_SECURE_ENV_VARS}" == "true" ]; then
      echo;
      echo "Running Sonar build";
      mvn clean org.jacoco:jacoco-maven-plugin:prepare-agent install sonar:sonar -Dsha1=$APP_VERSION -Dchangelist=$BRANCH;
    fi;
  - |
    if [ "${TRAVIS_SECURE_ENV_VARS}" == "false" ]; then
      echo;
      echo "Running Pull Request build without Sonar";
      mvn clean install;
    fi;
after_success:
  - docker build -t dniel/forwardauth .

deploy:
  - provider: script
    skip_cleanup: true
    script: "./.travis/deploy_release.sh"
    on:
      branch: master
  - provider: script
    skip_cleanup: true
    script: "./.travis/deploy_feature.sh"
    on:
      all_branches: true
      if: $BRANCH != "master"

notifications:
  slack:
    rooms:
     - secure: "N1VX3fGQKER1fiOn3QiHJ/ptkd+t22VsopR5XmkXfoXjlfczR76Baje2deUYjd+SHtv58isOoO0RVEgQ9QMz62Yu5Bj5CNO9u7ReW5xI/btu8lFrsmGtwbGUR27zwSwe4nihsVi1oJ24H5fQ6FKUm+gjm1f1ySeYhL7XVpdMaQD8wfbk4bU/+ZFddX2ucr+QVPBCZvPHc1WOAOFkGPY74zO8Q9E7NVelrOPoRsVvHfBPd3utoqMKPa5d3H+MPwZUtyq7y0fsPfJXy/1SamFvLCe2QYPLtuMi/js1oeI8oJu1q+L0UWegTqg6LBZp390a7/FVEr/fWFEm83Ofq9zNepSJweA0kMunDdv9MybQ1ATJE7ICUD4gBVrAuImHBi3Rcy4oZTWVowncaijEVb08xcty9yj2im6a3HPl+QRC3+9+FpegO/ouJjCGG02csau2vAMp4DfKCIIccWeTG1zfMc1QEMSmK36BrUIB2dwTluOJHANhmUNKCH4zKhTEDS/4ip35/tSHmO1jR01Tx7BLJSCNtg0Kn1cdB7nuYUOKgvCjjwfIwBqPXZh2xJDpgfof4ZdOyOE87tTTjtXgxYuL4zml+tZFWdLEOh8Sx04D5DgQ8XfiSyNY0Im8xBmE8MsweeTdaNjMvtoq9jkyxwejgyowSjoEPKfWVlKgOdUmOKo="
#    - dniel:7Efn86xOzM4GvPdWaGoiNC99